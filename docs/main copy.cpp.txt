// file main.cpp:

#include "BackupUtility/BackupUtility.hpp"
#include "cxxopts.hpp"

#include <filesystem>
#include <iostream>

namespace fs = std::filesystem;

cxxopts::ParseResult ParseCommandLineOptions(int argc, char* argv[])
{
    cxxopts::Options options("rdemo-backup", "Demo Backup Utility");

    // clang-format off
    options.add_options()
        ("s,source",  "Source directory", cxxopts::value<std::string>())
        ("b,backup",  "Backup directory", cxxopts::value<std::string>())
        ("v,verbose", "Verbose output")
        ("h,help",    "Print help");
    // clang-format on

    auto parse_result = options.parse(argc, argv);

    if ((parse_result.count("help")) || (!parse_result.count("source")) || (!parse_result.count("backup")))
    {
        std::cout << options.help() << '\n';
        exit(0); // Exit after displaying help
    }
    return parse_result;
}

BackupConfig CreateBackupConfiguration(const cxxopts::ParseResult& parse_result)
{
    BackupConfig backupConfiguration;

    backupConfiguration.sourceDir = fs::path(parse_result["source"].as<std::string>());
    backupConfiguration.backupRoot = fs::path(parse_result["backup"].as<std::string>());
    backupConfiguration.verbose = (0 < parse_result.count("verbose"));
    backupConfiguration.databaseFile = backupConfiguration.backupRoot / "backup.db";

    std::error_code error_code;
    backupConfiguration.sourceDir = fs::canonical(backupConfiguration.sourceDir, error_code);
    if ((error_code) || (!fs::is_directory(backupConfiguration.sourceDir)))
    {
        std::cerr << "Invalid source directory\n";
        exit(1);
    }

    fs::create_directories(backupConfiguration.backupRoot, error_code);
    if (error_code)
    {
        std::cerr << "Failed to create backup directory\n";
        exit(1);
    }

    return backupConfiguration;
}

int main(int argc, char* argv[])
{
    cxxopts::ParseResult commandLineOptions = ParseCommandLineOptions(argc, argv);
    BackupConfig backupConfiguration = CreateBackupConfiguration(commandLineOptions);

    if (backupConfiguration.verbose)
    {
        backupConfiguration.onProgress = [](const BackupProgress& progress)
        { std::cout << "[" << progress.stage << "] " << progress.processed << "/" << progress.total << " : " << progress.file << '\n'; };
    }

    if (!RunBackup(backupConfiguration))
    {
        std::cerr << "Backup failed\n";
        exit(1);
    }

    if (backupConfiguration.verbose)
    {
        std::cout << "Backup completed successfully\n";
    }

    exit(0);
}
